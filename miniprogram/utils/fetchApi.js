"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const defaultAuth = "opV_P5";
const api_1 = require("../configs/api");
class ApiFetch {
    constructor(params) {
        this.withBaseURL = params.withBaseURL || false;
        this.baseURL = params.baseURL;
        this.header = params.header;
    }
    fetch(method, url, data, noTokenRequired, showLoading) {
        const _this = this;
        if (!noTokenRequired) {
            const loginData = wx.getStorageSync("loginData");
            const authToken = loginData ? loginData["unionId"] : wx.getStorageSync("unionId");
            _this.header.Authorization = authToken || _this.header.Authorization;
        }
        return new Promise((resolve, reject) => {
            wx.request({
                header: _this.header,
                data: data,
                url: _this.withBaseURL ? _this.baseURL + url : url,
                method: method || "GET",
                success(res) {
                    handleRes(res, resolve, reject);
                },
                fail(e) {
                    wx.showToast({
                        title: `接口调用失败:${e.errMsg}`,
                        icon: "none"
                    });
                },
                complete() {
                    showLoading ? wx.hideLoading() : null;
                }
            });
        });
    }
}
exports.ApiFetch = ApiFetch;
const handleRes = (res, resolve, reject) => {
    const statusCode = res.statusCode;
    const resData = res.data;
    if (statusCode >= 200 && statusCode < 300) {
        if (!judgeErrCode(resData.errCode, reject)) {
            resolve(resData);
        }
    } else {
        judgeStatusCode(res.statusCode, reject);
    }
};
const judgeErrCode = (errCode, reject) => {
    let hint;
    switch (errCode) {
        case 0:
            break;
        default:
            hint = "未知错误！";
    }
    if (hint) {
        wx.showToast({
            title: hint,
            icon: "none"
        });
        reject();
    }
    return hint;
};
const judgeStatusCode = (statusCode, reject) => {
    let hint;
    switch (statusCode) {
        case 404:
            hint = "服务器正在升级...";
            break;
        default:
            hint = `服务器正在维护中，请稍后再试！ 状态码：${statusCode}`;
    }
    if (hint) {
        wx.showToast({
            title: hint,
            icon: "none"
        });
        reject();
    }
};
const fetchApi = new ApiFetch({
    baseURL: api_1.BaseUrl,
    withBaseURL: true,
    header: {
        "content-type": "application/json",
        Authorization: defaultAuth
    }
});
exports.fetchApi = fetchApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmV0Y2hBcGkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmZXRjaEFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQztBQUM3Qix3Q0FBeUM7QUFFekMsTUFBTSxRQUFRO0lBS1osWUFBWSxNQUFpQjtRQUMzQixJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLElBQUksS0FBSyxDQUFDO1FBQy9DLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUM5QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDOUIsQ0FBQztJQUVELEtBQUssQ0FDSCxNQVNhLEVBQ2IsR0FBVyxFQUNYLElBQWEsRUFDYixlQUF5QixFQUN6QixXQUFxQjtRQUVyQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNwQixNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sU0FBUyxHQUFHLFNBQVM7Z0JBQ3pCLENBQUMsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDO2dCQUN0QixDQUFDLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNqQyxLQUFLLENBQUMsTUFBTSxDQUFDLGFBQWEsR0FBRyxTQUFTLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7U0FDdEU7UUFFRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBaUIsRUFBRSxNQUFnQixFQUFFLEVBQUU7WUFDekQsRUFBRSxDQUFDLE9BQU8sQ0FBQztnQkFDVCxNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07Z0JBQ3BCLElBQUksRUFBRSxJQUFJO2dCQUNWLEdBQUcsRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRztnQkFDbEQsTUFBTSxFQUFFLE1BQU0sSUFBSSxLQUFLO2dCQUN2QixPQUFPLENBQUMsR0FBRztvQkFDVCxTQUFTLENBQWUsR0FBRyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDaEQsQ0FBQztnQkFDRCxJQUFJLENBQUMsQ0FBQztvQkFDSixFQUFFLENBQUMsU0FBUyxDQUFDO3dCQUNYLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQyxNQUFNLEVBQUU7d0JBQzNCLElBQUksRUFBRSxNQUFNO3FCQUNiLENBQUMsQ0FBQztnQkFDTCxDQUFDO2dCQUNELFFBQVE7b0JBQ04sV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDeEMsQ0FBQzthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBMkRRLDRCQUFRO0FBekRqQixNQUFNLFNBQVMsR0FBRyxDQUFDLEdBQWlCLEVBQUUsT0FBaUIsRUFBRSxNQUFnQixFQUFFLEVBQUU7SUFDM0UsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQztJQUNsQyxNQUFNLE9BQU8sR0FBZSxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQ3JDLElBQUksVUFBVSxJQUFJLEdBQUcsSUFBSSxVQUFVLEdBQUcsR0FBRyxFQUFFO1FBQ3pDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsRUFBRTtZQUMxQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDbEI7S0FDRjtTQUFNO1FBQ0wsZUFBZSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDekM7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLFlBQVksR0FBRyxDQUFDLE9BQWUsRUFBRSxNQUFnQixFQUFFLEVBQUU7SUFDekQsSUFBSSxJQUFJLENBQUM7SUFDVCxRQUFRLE9BQU8sRUFBRTtRQUNmLEtBQUssQ0FBQztZQUNKLE1BQU07UUFDUjtZQUNFLElBQUksR0FBRyxPQUFPLENBQUM7S0FDbEI7SUFDRCxJQUFJLElBQUksRUFBRTtRQUNSLEVBQUUsQ0FBQyxTQUFTLENBQUM7WUFDWCxLQUFLLEVBQUUsSUFBSTtZQUNYLElBQUksRUFBRSxNQUFNO1NBQ2IsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxFQUFFLENBQUM7S0FDVjtJQUNELE9BQU8sSUFBSSxDQUFBO0FBQ2IsQ0FBQyxDQUFBO0FBRUQsTUFBTSxlQUFlLEdBQUcsQ0FBQyxVQUFrQixFQUFFLE1BQVcsRUFBRSxFQUFFO0lBQzFELElBQUksSUFBSSxDQUFDO0lBQ1QsUUFBUSxVQUFVLEVBQUU7UUFDbEIsS0FBSyxHQUFHO1lBQ04sSUFBSSxHQUFHLFlBQVksQ0FBQztZQUNwQixNQUFNO1FBQ1I7WUFDRSxJQUFJLEdBQUcsdUJBQXVCLFVBQVUsRUFBRSxDQUFDO0tBQzlDO0lBQ0QsSUFBSSxJQUFJLEVBQUU7UUFDUixFQUFFLENBQUMsU0FBUyxDQUFDO1lBQ1gsS0FBSyxFQUFFLElBQUk7WUFDWCxJQUFJLEVBQUUsTUFBTTtTQUNiLENBQUMsQ0FBQztRQUNILE1BQU0sRUFBRSxDQUFDO0tBQ1Y7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQztJQUM1QixPQUFPLEVBQUUsYUFBTztJQUNoQixXQUFXLEVBQUUsSUFBSTtJQUNqQixNQUFNLEVBQUU7UUFDTixjQUFjLEVBQUUsa0JBQWtCO1FBQ2xDLGFBQWEsRUFBRSxXQUFXO0tBQzNCO0NBQ0YsQ0FBQyxDQUFDO0FBRWdCLDRCQUFRIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZGVmYXVsdEF1dGggPSBcIm9wVl9QNVwiO1xyXG5pbXBvcnQgeyBCYXNlVXJsIH0gZnJvbSBcIi4uL2NvbmZpZ3MvYXBpXCI7XHJcbmltcG9ydCB7IGh0dHBIZWFkZXIsIEFwaVBhcmFtcywgaHR0cFJlc3BvbnNlLCByZXN1bHREYXRhIH0gZnJvbSBcIi4uL21vZGVscy9odHRwXCI7XHJcbmNsYXNzIEFwaUZldGNoIHtcclxuICB3aXRoQmFzZVVSTDogYm9vbGVhbjtcclxuICBiYXNlVVJMOiBzdHJpbmc7XHJcbiAgaGVhZGVyOiBodHRwSGVhZGVyO1xyXG5cclxuICBjb25zdHJ1Y3RvcihwYXJhbXM6IEFwaVBhcmFtcykge1xyXG4gICAgdGhpcy53aXRoQmFzZVVSTCA9IHBhcmFtcy53aXRoQmFzZVVSTCB8fCBmYWxzZTtcclxuICAgIHRoaXMuYmFzZVVSTCA9IHBhcmFtcy5iYXNlVVJMO1xyXG4gICAgdGhpcy5oZWFkZXIgPSBwYXJhbXMuaGVhZGVyO1xyXG4gIH1cclxuXHJcbiAgZmV0Y2goXHJcbiAgICBtZXRob2Q6XHJcbiAgICAgIHwgXCJHRVRcIlxyXG4gICAgICB8IFwiT1BUSU9OU1wiXHJcbiAgICAgIHwgXCJIRUFEXCJcclxuICAgICAgfCBcIlBPU1RcIlxyXG4gICAgICB8IFwiUFVUXCJcclxuICAgICAgfCBcIkRFTEVURVwiXHJcbiAgICAgIHwgXCJUUkFDRVwiXHJcbiAgICAgIHwgXCJDT05ORUNUXCJcclxuICAgICAgfCB1bmRlZmluZWQsXHJcbiAgICB1cmw6IHN0cmluZyxcclxuICAgIGRhdGE/OiBvYmplY3QsXHJcbiAgICBub1Rva2VuUmVxdWlyZWQ/OiBib29sZWFuLFxyXG4gICAgc2hvd0xvYWRpbmc/OiBib29sZWFuXHJcbiAgKSB7XHJcbiAgICBjb25zdCBfdGhpcyA9IHRoaXM7XHJcbiAgICBpZiAoIW5vVG9rZW5SZXF1aXJlZCkge1xyXG4gICAgICBjb25zdCBsb2dpbkRhdGEgPSB3eC5nZXRTdG9yYWdlU3luYyhcImxvZ2luRGF0YVwiKTtcclxuICAgICAgY29uc3QgYXV0aFRva2VuID0gbG9naW5EYXRhXHJcbiAgICAgICAgPyBsb2dpbkRhdGFbXCJ1bmlvbklkXCJdXHJcbiAgICAgICAgOiB3eC5nZXRTdG9yYWdlU3luYyhcInVuaW9uSWRcIik7XHJcbiAgICAgIF90aGlzLmhlYWRlci5BdXRob3JpemF0aW9uID0gYXV0aFRva2VuIHx8IF90aGlzLmhlYWRlci5BdXRob3JpemF0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTogRnVuY3Rpb24sIHJlamVjdDogRnVuY3Rpb24pID0+IHtcclxuICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgaGVhZGVyOiBfdGhpcy5oZWFkZXIsXHJcbiAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICB1cmw6IF90aGlzLndpdGhCYXNlVVJMID8gX3RoaXMuYmFzZVVSTCArIHVybCA6IHVybCxcclxuICAgICAgICBtZXRob2Q6IG1ldGhvZCB8fCBcIkdFVFwiLFxyXG4gICAgICAgIHN1Y2Nlc3MocmVzKSB7XHJcbiAgICAgICAgICBoYW5kbGVSZXMoPGh0dHBSZXNwb25zZT5yZXMsIHJlc29sdmUsIHJlamVjdCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBmYWlsKGUpIHtcclxuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XHJcbiAgICAgICAgICAgIHRpdGxlOiBg5o6l5Y+j6LCD55So5aSx6LSlOiR7ZS5lcnJNc2d9YCxcclxuICAgICAgICAgICAgaWNvbjogXCJub25lXCJcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY29tcGxldGUoKSB7XHJcbiAgICAgICAgICBzaG93TG9hZGluZyA/IHd4LmhpZGVMb2FkaW5nKCkgOiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IGhhbmRsZVJlcyA9IChyZXM6IGh0dHBSZXNwb25zZSwgcmVzb2x2ZTogRnVuY3Rpb24sIHJlamVjdDogRnVuY3Rpb24pID0+IHtcclxuICBjb25zdCBzdGF0dXNDb2RlID0gcmVzLnN0YXR1c0NvZGU7XHJcbiAgY29uc3QgcmVzRGF0YSA9IDxyZXN1bHREYXRhPnJlcy5kYXRhO1xyXG4gIGlmIChzdGF0dXNDb2RlID49IDIwMCAmJiBzdGF0dXNDb2RlIDwgMzAwKSB7XHJcbiAgICBpZiAoIWp1ZGdlRXJyQ29kZShyZXNEYXRhLmVyckNvZGUsIHJlamVjdCkpIHtcclxuICAgICAgcmVzb2x2ZShyZXNEYXRhKTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAganVkZ2VTdGF0dXNDb2RlKHJlcy5zdGF0dXNDb2RlLCByZWplY3QpO1xyXG4gIH1cclxufVxyXG5cclxuY29uc3QganVkZ2VFcnJDb2RlID0gKGVyckNvZGU6IG51bWJlciwgcmVqZWN0OiBGdW5jdGlvbikgPT4ge1xyXG4gIGxldCBoaW50O1xyXG4gIHN3aXRjaCAoZXJyQ29kZSkge1xyXG4gICAgY2FzZSAwOlxyXG4gICAgICBicmVhaztcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIGhpbnQgPSBcIuacquefpemUmeivr++8gVwiO1xyXG4gIH1cclxuICBpZiAoaGludCkge1xyXG4gICAgd3guc2hvd1RvYXN0KHtcclxuICAgICAgdGl0bGU6IGhpbnQsXHJcbiAgICAgIGljb246IFwibm9uZVwiXHJcbiAgICB9KTtcclxuICAgIHJlamVjdCgpO1xyXG4gIH1cclxuICByZXR1cm4gaGludFxyXG59XHJcblxyXG5jb25zdCBqdWRnZVN0YXR1c0NvZGUgPSAoc3RhdHVzQ29kZTogbnVtYmVyLCByZWplY3Q6IGFueSkgPT4ge1xyXG4gIGxldCBoaW50O1xyXG4gIHN3aXRjaCAoc3RhdHVzQ29kZSkge1xyXG4gICAgY2FzZSA0MDQ6XHJcbiAgICAgIGhpbnQgPSBcIuacjeWKoeWZqOato+WcqOWNh+e6py4uLlwiO1xyXG4gICAgICBicmVhaztcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIGhpbnQgPSBg5pyN5Yqh5Zmo5q2j5Zyo57u05oqk5Lit77yM6K+356iN5ZCO5YaN6K+V77yBIOeKtuaAgeegge+8miR7c3RhdHVzQ29kZX1gO1xyXG4gIH1cclxuICBpZiAoaGludCkge1xyXG4gICAgd3guc2hvd1RvYXN0KHtcclxuICAgICAgdGl0bGU6IGhpbnQsXHJcbiAgICAgIGljb246IFwibm9uZVwiXHJcbiAgICB9KTtcclxuICAgIHJlamVjdCgpO1xyXG4gIH1cclxufVxyXG5cclxuY29uc3QgZmV0Y2hBcGkgPSBuZXcgQXBpRmV0Y2goe1xyXG4gIGJhc2VVUkw6IEJhc2VVcmwsXHJcbiAgd2l0aEJhc2VVUkw6IHRydWUsXHJcbiAgaGVhZGVyOiB7XHJcbiAgICBcImNvbnRlbnQtdHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcclxuICAgIEF1dGhvcml6YXRpb246IGRlZmF1bHRBdXRoXHJcbiAgfVxyXG59KTtcclxuXHJcbmV4cG9ydCB7IEFwaUZldGNoLCBmZXRjaEFwaSB9O1xyXG4iXX0=
